name: Daily Backfill

on:
  schedule:
    # GitHub Actions uses UTC. 06:00 UTC = 14:00 UTC+08 every day
    - cron: '0 6 * * *'
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: daily-backfill
  cancel-in-progress: false

jobs:
  run-backfill:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Clean old builds
        run: |
          pip uninstall -y numpy pandas || true
          python -m pip cache purge || true
          pip cache purge || true

      - name: Install dependencies (if any)
        run: |
          if [ -f requirements.txt ]; then
            echo "numpy==1.26.4" > constraints.txt
            pip install --no-cache-dir -r requirements.txt -c constraints.txt
          fi

      - name: Run daily backfill
        env:
          TZ: Asia/Taipei
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          NEON_DATABASE_URL: ${{ secrets.NEON_DATABASE_URL }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_NAME: ${{ secrets.DB_NAME }}
          DB_USER: ${{ secrets.DB_USER }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_SSLMODE: ${{ secrets.DB_SSLMODE }}
        run: |
          python -c "
          from datetime import datetime, timedelta
          import runpy, pathlib
          from psycopg2.extras import execute_values
          import logging
          
          # 動態載入 server.py，取得所需類別
          m = runpy.run_path(str(pathlib.Path('server.py')))
          DatabaseManager = m['DatabaseManager']
          BWIBBUFetcher = m['BWIBBUFetcher']
          
          logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
          logger = logging.getLogger(__name__)
          
          # 計算今天的日期
          today = datetime.now().date()
          start_date = today.strftime('%Y-%m-%d')
          end_date = today.strftime('%Y-%m-%d')
          
          logger.info(f'開始抓取 {start_date} 的最新資料')
          
          # 初始化資料庫
          db = DatabaseManager(use_local=False)
          if not db.connect():
              logger.error('資料庫連線失敗')
              exit(1)
          
          try:
              db.create_tables()
              
              # 初始化抓取器並抓取資料
              fetcher = BWIBBUFetcher()
              logger.info(f'正在抓取 {start_date} 的 BWIBBU 資料...')
              records, daily_stats = fetcher.fetch_range_stats(start_date, end_date)
              
              if not records:
                  logger.info(f'指定期間 {start_date} 無有效資料')
              else:
                  # 寫入資料庫
                  cursor = db.connection.cursor()
                  values = []
                  
                  for rec in records:
                      try:
                          rec_date = datetime.strptime(rec['date'], '%Y-%m-%d').date()
                          values.append((
                              rec['code'],
                              rec_date,
                              rec['name'],
                              rec['pe_ratio'],
                              rec['dividend_yield'],
                              rec['pb_ratio']
                          ))
                      except Exception as e:
                          logger.warning(f'記錄解析失敗: {e}')
                          continue
                  
                  if values:
                      upsert_sql = '''
                          INSERT INTO tw_stock_bwibbu (code, date, name, pe_ratio, dividend_yield, pb_ratio)
                          VALUES %s
                          ON CONFLICT (code, date) DO UPDATE SET
                              name = EXCLUDED.name,
                              pe_ratio = EXCLUDED.pe_ratio,
                              dividend_yield = EXCLUDED.dividend_yield,
                              pb_ratio = EXCLUDED.pb_ratio,
                              updated_at = CURRENT_TIMESTAMP
                      '''
                      execute_values(cursor, upsert_sql, values, page_size=500)
                      db.connection.commit()
                      logger.info(f'成功寫入 {len(values)} 筆記錄到資料庫')
                      logger.info(f'每日統計: {daily_stats}')
          finally:
              db.disconnect()
          "
